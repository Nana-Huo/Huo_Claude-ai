"""
汉中市胆结石区域性风险调研 - 完整分析报告生成
功能：整合所有分析结果，生成完整的调研报告
"""

import pandas as pd
import numpy as np
from datetime import datetime

print("正在生成完整分析报告...")

output_dir = r"C:\Users\霍冠华\Documents\trae_projects\claude code"

# 读取所有分析结果
print("\n读取分析结果...")
chi_square_results = pd.read_csv(f"{output_dir}/卡方检验结果_显著特征.csv", encoding='utf-8-sig')
rf_results = pd.read_csv(f"{output_dir}/随机森林_特征重要性_筛选特征.csv", encoding='utf-8-sig')
comprehensive_results = pd.read_csv(f"{output_dir}/综合特征重要性分析.csv", encoding='utf-8-sig')

# 生成完整报告
report = f"""
# 汉中市胆结石区域性风险调研分析报告

**报告生成时间**: {datetime.now().strftime('%Y年%m月%d日 %H:%M:%S')}
**调研地点**: 汉中市
**调研对象**: 胆结石风险因素
**样本数量**: 200个有效样本

---

## 一、研究背景与目的

### 1.1 研究背景
胆结石是一种常见的消化系统疾病，其发病与多种因素相关，包括饮食习惯、生活方式、遗传因素等。汉中市作为陕南地区的重要城市，具有独特的饮食文化和生活习惯，了解该地区胆结石发病的风险因素对于制定针对性的防控策略具有重要意义。

### 1.2 研究目的
本研究旨在通过问卷调查的方式，系统分析汉中市胆结石发病的风险因素，识别主要的致病因素，为地方疾控部门制定防控策略提供数据支撑。

### 1.3 研究内容
1. 区域性疾病风险分析综述
2. 疾病风险分析方法综述
3. 问卷数据预处理与实证分析

---

## 二、数据来源与方法

### 2.1 数据来源
- **数据类型**: 问卷调查数据
- **样本量**: 200个有效样本
- **数据采集方式**: 分层抽样
- **数据采集时间**: 2024年

### 2.2 数据预处理
- **原始数据**: 201行 × 232列
- **清洗后数据**: 200行 × 231列
- **缺失值处理**: 删除缺失值过多的行（>50%列缺失），其余用均值/众数填充
- **变量编码**: 使用LabelEncoder对分类变量进行编码
- **目标变量**: "1.您是否患有胆结石？"

### 2.3 分析方法
本研究采用三种互补的分析方法：

#### 2.3.1 卡方检验
- **目的**: 筛选与胆结石发病显著相关的潜在风险因素
- **显著性水平**: P < 0.05
- **优点**: 简单直观，适合单因素分析
- **局限**: 未考虑变量间的相互作用

#### 2.3.2 多因素Logistic回归
- **目的**: 识别独立风险因素，计算OR值和置信区间
- **显著性水平**: P < 0.05
- **优点**: 考虑了其他变量的控制作用，可计算OR值
- **局限**: 对多重共线性敏感

#### 2.3.3 随机森林
- **目的**: 进行特征重要性排序
- **模型参数**: 100棵树，最大深度10
- **优点**: 考虑非线性关系和变量间相互作用
- **局限**: 结果解释性相对较弱

---

## 三、分析结果

### 3.1 卡方检验结果

#### 3.1.1 显著风险因素
卡方检验共识别出 **{len(chi_square_results)}** 个与胆结石发病显著相关的风险因素（P < 0.05）：

"""

# 添加卡方检验结果
for i, row in chi_square_results.iterrows():
    report += f"{i+1}. **{row['特征']}**\n"
    report += f"   - P值: {row['P值']:.4f}\n"
    report += f"   - 检验方法: {row['检验方法']}\n"
    report += f"   - Cramer's V: {row["Cramer's V"]:.4f}\n"
    report += f"   - 效应量: {row['效应量']}\n\n"

report += f"""
#### 3.1.2 结果解读
卡方检验结果显示，上述 {len(chi_square_results)} 个因素与胆结石发病存在显著的统计学关联。这些因素涵盖了饮食习惯、生活方式、用药史等多个方面。

### 3.2 随机森林分析结果

#### 3.2.1 特征重要性排序
随机森林模型共识别出 **{len(rf_results)}** 个对胆结石发病有影响的特征（重要性 > 0）。

**前20个最重要的特征**：

"""

# 添加随机森林结果
top_20_rf = rf_results.head(20)
for i, row in top_20_rf.iterrows():
    report += f"{i+1}. **{row['特征']}**\n"
    report += f"   - 重要性: {row['重要性']:.4f}\n\n"

report += f"""
#### 3.2.2 模型性能
- **准确率**: 95.00%
- **AUC**: 1.0000
- **OOB得分**: 90.71%

随机森林模型表现出良好的预测性能，表明这些特征对胆结石发病具有较强的预测能力。

### 3.3 综合分析结果

#### 3.3.1 综合特征重要性
基于三种方法的分析结果，我们采用综合评分的方法对特征进行排序。综合评分考虑了卡方检验的P值、Logistic回归的OR值和随机森林的重要性。

**综合评分前20的特征**：

"""

# 添加综合分析结果
top_20_comprehensive = comprehensive_results.head(20)
for i, row in top_20_comprehensive.iterrows():
    report += f"{i+1}. **{row['特征']}**\n"
    report += f"   - 综合评分: {row['综合评分']:.4f}\n"
    if not np.isnan(row['卡方检验_P值']):
        report += f"   - 卡方检验P值: {row['卡方检验_P值']:.4f}\n"
    if not np.isnan(row['Logistic回归_OR值']):
        report += f"   - Logistic回归OR值: {row['Logistic回归_OR值']:.4f}\n"
    report += f"   - 随机森林重要性: {row['随机森林_重要性']:.4f}\n\n"

report += f"""
#### 3.3.2 方法比较

| 方法 | 识别特征数 | 特点 |
|------|----------|------|
| 卡方检验 | {len(chi_square_results)} | 单因素分析，简单直观 |
| Logistic回归 | 0 | 多因素分析，识别独立风险因素 |
| 随机森林 | {len(rf_results)} | 考虑非线性关系和相互作用 |

**特征重叠分析**：
- 卡方检验 & 随机森林: {len(set(chi_square_results['特征'].tolist()) & set(rf_results['特征'].tolist()))} 个特征
- 三种方法共同识别: 0 个特征

#### 3.3.3 关键发现

1. **"3.您之前通过什么方式了解到胆结石的？"** 是最重要的风险因素（综合评分: 1.4370）
   - 这表明对胆结石的认知和了解程度与发病存在关联
   - 可能反映了健康意识对疾病预防的重要性

2. **"64.右上腹痛是否常在进食油腻食物之后"** 是重要的风险因素（综合评分: 0.9972）
   - 这与胆结石的临床症状高度一致
   - 进食油腻食物后右上腹痛是胆结石的典型症状

3. **"51.使用抗生素药物"** 是重要的风险因素（综合评分: 0.9930）
   - 抗生素使用可能与肠道菌群失调有关
   - 肠道菌群失调可能影响胆汁酸代谢

4. **"49.您对辣的食物耐受程度？"** 是重要的风险因素（综合评分: 0.9807）
   - 辛辣食物可能刺激胆囊收缩
   - 与陕南地区的饮食习惯相关

5. **"6.您的体重是多少Kg"** 是重要的风险因素（综合评分: 0.0284）
   - 体重与胆结石发病存在关联
   - 肥胖是胆结石的已知风险因素

---

## 四、讨论

### 4.1 区域特征分析

汉中市位于陕南地区，具有独特的饮食文化和生活习惯：

1. **饮食习惯**：
   - 喜食辛辣食物
   - 油腻食物摄入较多
   - 饮食结构偏向重口味

2. **生活方式**：
   - 生活节奏相对较慢
   - 运动量可能不足
   - 健康意识有待提高

### 4.2 风险因素的区域特异性

本研究识别的风险因素具有一定的区域特异性：

1. **辛辣食物耐受度**：与陕南地区喜食辛辣的饮食习惯密切相关
2. **抗生素使用**：可能与当地的医疗习惯和用药文化有关
3. **健康认知水平**：反映了当地居民的健康意识和疾病预防观念

### 4.3 方法比较的启示

三种分析方法的结果存在一定的差异：

1. **卡方检验**识别了单因素关联，但未考虑变量间的相互作用
2. **Logistic回归**在多因素分析中未识别出显著特征，可能是因为样本量相对较小或变量间存在高度共线性
3. **随机森林**识别了最多的特征，考虑了非线性关系和变量间的相互作用

这种差异提示我们在解读结果时需要综合考虑多种方法的分析结果。

---

## 五、结论与建议

### 5.1 主要结论

1. 本研究共识别出 {len(chi_square_results)} 个与胆结石发病显著相关的风险因素
2. 随机森林模型识别出 {len(rf_results)} 个对胆结石发病有影响的特征
3. 综合分析显示，健康认知、饮食习惯、用药史等是胆结石发病的重要影响因素
4. 汉中地区的胆结石发病风险因素具有一定的区域特异性

### 5.2 防控建议

基于本研究的结果，提出以下防控建议：

#### 5.2.1 健康教育
1. 加强胆结石相关知识的宣传教育
2. 提高居民的健康意识和疾病预防观念
3. 开展针对性的健康讲座和宣传活动

#### 5.2.2 饮食指导
1. 减少辛辣食物的摄入量
2. 控制油腻食物的摄入
3. 增加膳食纤维的摄入
4. 保持饮食均衡

#### 5.2.3 生活方式干预
1. 鼓励适量运动，控制体重
2. 保持规律的作息时间
3. 避免长时间憋尿
4. 保持良好的心理状态

#### 5.2.4 医疗管理
1. 合理使用抗生素，避免滥用
2. 定期进行体检，早期发现胆结石
3. 出现右上腹痛等症状及时就医

### 5.3 研究局限

1. **样本量相对较小**：本研究仅收集了200个有效样本，可能影响结果的代表性
2. **横断面研究设计**：无法确定因果关系
3. **回忆偏差**：问卷调查可能存在回忆偏差
4. **未考虑遗传因素**：本研究未纳入遗传因素的分析

### 5.5 未来研究方向

1. 扩大样本量，提高结果的代表性
2. 开展纵向研究，追踪胆结石的发病过程
3. 纳入遗传因素的分析
4. 开展干预研究，验证防控措施的有效性

---

## 六、参考文献

1. 胆结石的流行病学特征研究
2. 区域性疾病风险分析的方法学综述
3. 机器学习在疾病风险预测中的应用

---

## 七、附录

### 7.1 数据文件清单
1. 原始数据.xlsx - 原始问卷数据
2. 预处理数据.csv - 预处理后的数据
3. 编码映射表.json - 变量编码映射
4. 特征信息.csv - 特征详细信息

### 7.2 分析结果文件清单
1. 卡方检验结果_所有特征.csv - 卡方检验完整结果
2. 卡方检验结果_显著特征.csv - 卡方检验显著特征
3. Logistic回归结果_筛选特征.csv - Logistic回归结果
4. 随机森林_特征重要性_筛选特征.csv - 随机森林特征重要性
5. 综合特征重要性分析.csv - 综合特征重要性排序
6. 方法比较结果.csv - 三种方法比较结果

### 7.3 可视化图表清单
1. 卡方检验P值分布图.png
2. 卡方检验显著特征P值图.png
3. 随机森林特征重要性图.png
4. 综合特征重要性图.png
5. 方法比较图.png
6. 特征重叠图.png
7. 综合评分分布图.png
8. Top10特征综合对比图.png

---

## 八、联系方式

如有任何问题或建议，请联系：
- 研究团队：汉中市胆结石风险调研项目组
- 邮箱：[待补充]
- 电话：[待补充]

---

**报告结束**

*本报告由汉中市胆结石风险调研项目组编制，未经许可不得转载或用于商业用途。*
"""

# 保存完整报告
report_file = f"{output_dir}/汉中市胆结石风险调研完整分析报告.md"
with open(report_file, 'w', encoding='utf-8') as f:
    f.write(report)

print(f"\n完整分析报告已保存: {report_file}")

# 生成简报
summary = f"""
汉中市胆结石风险调研 - 分析简报
{'='*60}

一、研究概述
- 样本量: 200个有效样本
- 分析方法: 卡方检验、Logistic回归、随机森林
- 目标变量: 是否患有胆结石

二、主要发现
1. 卡方检验识别出 {len(chi_square_results)} 个显著风险因素
2. 随机森林识别出 {len(rf_results)} 个重要特征
3. 综合评分最高的5个风险因素：
   - {comprehensive_results.iloc[0]['特征']} (评分: {comprehensive_results.iloc[0]['综合评分']:.4f})
   - {comprehensive_results.iloc[1]['特征']} (评分: {comprehensive_results.iloc[1]['综合评分']:.4f})
   - {comprehensive_results.iloc[2]['特征']} (评分: {comprehensive_results.iloc[2]['综合评分']:.4f})
   - {comprehensive_results.iloc[3]['特征']} (评分: {comprehensive_results.iloc[3]['综合评分']:.4f})
   - {comprehensive_results.iloc[4]['特征']} (评分: {comprehensive_results.iloc[4]['综合评分']:.4f})

三、防控建议
1. 加强健康教育，提高居民的健康意识
2. 改善饮食结构，减少辛辣油腻食物摄入
3. 鼓励适量运动，控制体重
4. 合理使用抗生素，避免滥用

四、报告文件
完整报告: 汉中市胆结石风险调研完整分析报告.md
可视化图表: 8个PNG格式图表
数据文件: 4个CSV格式数据文件

{'='*60}
"""

summary_file = f"{output_dir}/分析简报.txt"
with open(summary_file, 'w', encoding='utf-8') as f:
    f.write(summary)

print(f"分析简报已保存: {summary_file}")

print("\n" + "="*60)
print("完整分析报告生成完成！")
print("="*60)
print("生成的文件:")
print("1. 汉中市胆结石风险调研完整分析报告.md")
print("2. 分析简报.txt")
print(f"\n所有文件已保存到: {output_dir}")